{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 4,
   "execution_state": "idle",
   "id": "83b5b099-e16b-41bb-9301-0ba88da94d51",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-02T00:57:36.835810Z",
     "iopub.status.busy": "2025-11-02T00:57:36.835532Z",
     "iopub.status.idle": "2025-11-02T00:57:36.859540Z",
     "shell.execute_reply": "2025-11-02T00:57:36.858230Z",
     "shell.execute_reply.started": "2025-11-02T00:57:36.835787Z"
    }
   },
   "outputs": [
    {
     "ename": "ModuleNotFoundError",
     "evalue": "No module named 'dataExtractionFromLaw'",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mModuleNotFoundError\u001b[0m                       Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[4], line 6\u001b[0m\n\u001b[1;32m      4\u001b[0m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21;01mpath\u001b[39;00m\n\u001b[1;32m      5\u001b[0m \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21;01mpydantic\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mimport\u001b[39;00m BaseModel\n\u001b[0;32m----> 6\u001b[0m \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21;01mdataExtractionFromLaw\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mimport\u001b[39;00m getLawInformations\n",
      "\u001b[0;31mModuleNotFoundError\u001b[0m: No module named 'dataExtractionFromLaw'"
     ]
    },
    {
     "data": {
      "application/sagemaker-interactive-debugging": {
       "cell_id": "83b5b099-e16b-41bb-9301-0ba88da94d51",
       "debugging_info_folder": "/home/sagemaker-user/shared/.temp_sagemaker_unified_studio_debugging_info/83b5b099-e16b-41bb-9301-0ba88da94d51",
       "instruction_file": "/home/sagemaker-user/shared/.temp_sagemaker_unified_studio_debugging_info/ipython_debugging_sop.txt",
       "magic_command": "no_magic",
       "session_type": "python_3"
      }
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "\n",
    "import boto3\n",
    "import instructor\n",
    "import json\n",
    "import path\n",
    "from pydantic import BaseModel\n",
    "from dataExtractionFromLaw import getLawInformations"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "execution_state": "idle",
   "id": "eea46da8-39b7-4f11-8afc-ad69ecf0f1ed",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-02T00:55:11.302896Z",
     "iopub.status.busy": "2025-11-02T00:55:11.302449Z",
     "iopub.status.idle": "2025-11-02T00:55:13.254708Z",
     "shell.execute_reply": "2025-11-02T00:55:13.253575Z",
     "shell.execute_reply.started": "2025-11-02T00:55:11.302869Z"
    }
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Collecting path\n",
      "  Downloading path-17.1.1-py3-none-any.whl.metadata (6.5 kB)\n",
      "Downloading path-17.1.1-py3-none-any.whl (23 kB)\n",
      "Installing collected packages: path\n",
      "Successfully installed path-17.1.1\n"
     ]
    }
   ],
   "source": [
    "!pip install path"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "execution_state": "idle",
   "id": "a64ae0bb-d286-4676-b1d2-d2978fe7500b",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-02T00:55:25.966087Z",
     "iopub.status.busy": "2025-11-02T00:55:25.965796Z",
     "iopub.status.idle": "2025-11-02T00:55:26.248696Z",
     "shell.execute_reply": "2025-11-02T00:55:26.246884Z",
     "shell.execute_reply.started": "2025-11-02T00:55:25.966059Z"
    }
   },
   "outputs": [
    {
     "ename": "NameError",
     "evalue": "name 'boto3' is not defined",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[2], line 1\u001b[0m\n\u001b[0;32m----> 1\u001b[0m s3 \u001b[38;5;241m=\u001b[39m \u001b[43mboto3\u001b[49m\u001b[38;5;241m.\u001b[39mclient(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124ms3\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[1;32m      2\u001b[0m bedrock_client \u001b[38;5;241m=\u001b[39m boto3\u001b[38;5;241m.\u001b[39mclient(\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mbedrock-runtime\u001b[39m\u001b[38;5;124m'\u001b[39m)\n\u001b[1;32m      3\u001b[0m client \u001b[38;5;241m=\u001b[39m instructor\u001b[38;5;241m.\u001b[39mfrom_bedrock(bedrock_client)\n",
      "\u001b[0;31mNameError\u001b[0m: name 'boto3' is not defined"
     ]
    },
    {
     "data": {
      "application/sagemaker-interactive-debugging": {
       "cell_id": "a64ae0bb-d286-4676-b1d2-d2978fe7500b",
       "debugging_info_folder": "/home/sagemaker-user/shared/.temp_sagemaker_unified_studio_debugging_info/a64ae0bb-d286-4676-b1d2-d2978fe7500b",
       "instruction_file": "/home/sagemaker-user/shared/.temp_sagemaker_unified_studio_debugging_info/ipython_debugging_sop.txt",
       "magic_command": "no_magic",
       "session_type": "python_3"
      }
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "s3 = boto3.client(\"s3\")\n",
    "bedrock_client = boto3.client('bedrock-runtime')\n",
    "client = instructor.from_bedrock(bedrock_client)\n",
    "\n",
    "BUCKET_NAME = \"csv-file-store-ec51f700\"   \n",
    "PREFIX = \"dzd-3lz7fcr1rwmmkw/5h6d6xccl72dn4/dev/data/fillings\"\n",
    "\n",
    "response = s3.list_objects_v2(Bucket=BUCKET_NAME, Prefix=PREFIX)\n",
    "print(response)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "execution_state": "idle",
   "id": "968a942d-5f9c-4431-9b47-357210619ca8",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-02T00:50:37.969995Z",
     "iopub.status.busy": "2025-11-02T00:50:37.969647Z",
     "iopub.status.idle": "2025-11-02T00:50:37.976118Z",
     "shell.execute_reply": "2025-11-02T00:50:37.974736Z",
     "shell.execute_reply.started": "2025-11-02T00:50:37.969972Z"
    }
   },
   "outputs": [],
   "source": [
    "class Score(BaseModel):\n",
    "    score: int\n",
    "    reasoning: str\n",
    "\n",
    "\n",
    "def getScoreAndReasoning(data: str, law: str) -> Score:\n",
    "    response = client.chat.completions.create(\n",
    "            modelId=\"global.anthropic.claude-sonnet-3-20251001-v1:0\",\n",
    "            messages=[\n",
    "                {\n",
    "                    \"role\": \"user\",\n",
    "                    \"content\": (\n",
    "                        \"You are an expert in corporate regulatory analysis.\\n\"\n",
    "                        \"Your task is to assess how much a **new law or directive** impacts a given company.\\n\\n\"\n",
    "                        \"You will receive two JSON documents:\\n\"\n",
    "                        \"1. The **company's 10-K summary**, describing its business model, sectors, countries of operation, and risk factors.\\n\"\n",
    "                        \"2. The **law summary**, describing the countries, sectors, regulation types, measures imposed, and date of application.\\n\\n\"\n",
    "                        \"Your goal is to produce two outputs:\\n\"\n",
    "                        \"- **score** (integer 0‚Äì5): a numeric estimate of how strongly the law impacts this company.\\n\"\n",
    "                        \"- **reasoning** (string): a detailed justification for that score, citing specific matches or mismatches between the law and the company.\\n\\n\"\n",
    "                        \"Scoring scale:\\n\"\n",
    "                        \"0 ‚Üí No impact (law unrelated to company's sector or geography)\\n\"\n",
    "                        \"1 ‚Üí Minimal impact (indirect or partial exposure)\\n\"\n",
    "                        \"2 ‚Üí Limited impact (only some operations or markets affected)\\n\"\n",
    "                        \"3 ‚Üí Moderate impact (noticeable operational or compliance costs)\\n\"\n",
    "                        \"4 ‚Üí High impact (affects core business or significant regulatory burden)\\n\"\n",
    "                        \"5 ‚Üí Very high impact (fundamental change, major compliance costs, or legal risk)\\n\\n\"\n",
    "                        \"Consider:\\n\"\n",
    "                        \"- Whether the company operates in countries where the law applies.\\n\"\n",
    "                        \"- Whether its sectors or sub-sectors are mentioned in the law.\\n\"\n",
    "                        \"- Whether its risk factors already reference similar regulations.\\n\"\n",
    "                        \"- Whether the imposed measures directly restrict or burden its activities.\\n\"\n",
    "                        \"- Whether the law‚Äôs effective date aligns with the company‚Äôs current operations.\\n\\n\"\n",
    "                        \"Return your analysis following this schema:\\n\"\n",
    "                        \"{\\n\"\n",
    "                        \"  \\\"score\\\": <integer between 0 and 5>,\\n\"\n",
    "                        \"  \\\"reasoning\\\": <textual explanation of your reasoning>\\n\"\n",
    "                        \"}\\n\\n\"\n",
    "                        \"Here are the inputs:\\n\\n\"\n",
    "                        f\"--- COMPANY DATA ---\\n{data}\\n\\n\"\n",
    "                        f\"--- LAW DATA ---\\n{law}\"\n",
    "                        \n",
    "                    ),\n",
    "                },\n",
    "            ],\n",
    "            response_model=Score,\n",
    "            inferenceConfig={\n",
    "                \"maxTokens\": 64000,\n",
    "            }\n",
    "        )\n",
    "    \n",
    "    return {\"score\": response.score, \"reasoning\": response.reasoning}\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "8e76e1a0-1bd6-4ef1-8328-9eca983fa282",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-01T23:16:33.151321Z",
     "iopub.status.busy": "2025-11-01T23:16:33.150995Z",
     "iopub.status.idle": "2025-11-01T23:16:33.997351Z",
     "shell.execute_reply": "2025-11-01T23:16:33.996276Z",
     "shell.execute_reply.started": "2025-11-01T23:16:33.151298Z"
    }
   },
   "outputs": [
    {
     "ename": "ModuleNotFoundError",
     "evalue": "No module named 'dataExtractionFromLaw'",
     "output_type": "error",
     "traceback": [
      "\u001b[0;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[0;31mModuleNotFoundError\u001b[0m                       Traceback (most recent call last)",
      "Cell \u001b[0;32mIn[2], line 6\u001b[0m\n\u001b[1;32m      4\u001b[0m \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21;01mIPython\u001b[39;00m\u001b[38;5;21;01m.\u001b[39;00m\u001b[38;5;21;01mdisplay\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mimport\u001b[39;00m Markdown, display\n\u001b[1;32m      5\u001b[0m \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21;01mpydantic\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mimport\u001b[39;00m BaseModel\n\u001b[0;32m----> 6\u001b[0m \u001b[38;5;28;01mfrom\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21;01mdataExtractionFromLaw\u001b[39;00m\u001b[38;5;21;01m.\u001b[39;00m\u001b[38;5;21;01mipyn\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mimport\u001b[39;00m getLawInformations\n\u001b[1;32m      8\u001b[0m s3 \u001b[38;5;241m=\u001b[39m boto3\u001b[38;5;241m.\u001b[39mclient(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124ms3\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[1;32m      9\u001b[0m bedrock_client \u001b[38;5;241m=\u001b[39m boto3\u001b[38;5;241m.\u001b[39mclient(\u001b[38;5;124m'\u001b[39m\u001b[38;5;124mbedrock-runtime\u001b[39m\u001b[38;5;124m'\u001b[39m)\n",
      "\u001b[0;31mModuleNotFoundError\u001b[0m: No module named 'dataExtractionFromLaw'"
     ]
    },
    {
     "data": {
      "application/sagemaker-interactive-debugging": {
       "cell_id": "8e76e1a0-1bd6-4ef1-8328-9eca983fa282",
       "debugging_info_folder": "/home/sagemaker-user/shared/.temp_sagemaker_unified_studio_debugging_info/8e76e1a0-1bd6-4ef1-8328-9eca983fa282",
       "instruction_file": "/home/sagemaker-user/shared/.temp_sagemaker_unified_studio_debugging_info/ipython_debugging_sop.txt",
       "magic_command": "no_magic",
       "session_type": "python_3"
      }
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "def getConcernedEntreprises(law_summarized: str, entreprises_path: str) -> dict:\n",
    "\n",
    "    response = s3.list_objects_v2(Bucket=BUCKET_NAME, Prefix=PREFIX)\n",
    "\n",
    "    if \"Contents\" not in response:\n",
    "        print(\"Aucun fichier trouv√© dans ce chemin S3.\")\n",
    "    else:\n",
    "        results = {}\n",
    "        for obj in response[\"Contents\"]:\n",
    "            key = obj[\"Key\"]\n",
    "            folder_name = path.dirname(key).split('/')[-1]\n",
    "\n",
    "            if not key.endswith(\".json\"):\n",
    "                continue\n",
    "\n",
    "            print(f\"üìÇ Lecture du fichier : {key}\")\n",
    "\n",
    "            continue\n",
    "\n",
    "            file_obj = s3.get_object(Bucket=BUCKET_NAME, Key=key)\n",
    "            file_content = file_obj[\"Body\"].read().decode(\"utf-8\")\n",
    "\n",
    "\n",
    "            try:\n",
    "                data = json.loads(file_content)\n",
    "                results[folder_name] = getScoreAndReasoning(data, law_summarized)\n",
    "\n",
    "            except json.JSONDecodeError:\n",
    "                print(f\"‚ö†Ô∏è Erreur de parsing JSON dans {key}\")\n",
    "                continue\n",
    "\n",
    "\n",
    "        return results\n",
    "\n",
    "if __name__ == \"__main__\":\n",
    "    process_all_fillings()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "5f045a90-b414-4999-a25b-30367b540cfe",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.11"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
